<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Version208 extends Doctrine_Migration_Base {
	public function up() {
		$this->addColumn('identification', 'yearly_count', 'integer', '8', array('notnull' => '1'));
	}

	public function postUp() {
		$identificationTable = Doctrine_Core::getTable('Identification');

		$identifications = $identificationTable->createQuery('i')->execute();
		foreach ($identifications as $identification) {
			$year = date('Y', strtotime($identification->getIdentificationDate()));

			$minDate = sprintf('%s-01-01', $year);
			$maxDate = sprintf('%s-12-31', $year);
			$nextValue = $identificationTable->createQuery('i')
				->where('i.identification_date >= ?', $minDate)
				->andWhere('i.identification_date <= ?', $maxDate)
				->andWhere('i.yearly_count != 0')
				->count();
			$nextValue += 1;

			$identification->setYearlyCount($nextValue);
			echo ">>\tYear: $year, count: $nextValue\n";
			$identification->trySave();
		}
	}

	public function down() {
		$this->removeColumn('identification', 'yearly_count');
	}
}
